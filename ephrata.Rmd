---
title: "DMML_test"
author: ' '
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---


```{r}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(data.table)
library(tableone)
library(tidyr)
library(patchwork)
library(naniar)
library(janitor)
```

```{r}
data <- read.csv("merged_df_NEW.csv")
RF_impute_df <- fread("RF_imputation_NEW.csv")
data = subset(data, select = -c(deathtime, survival_time))
```



```{r}
vars <- c("age", "gendera")

data$gendera <- factor(data$gendera, levels = c(1, 2), labels = c("Male", "Female"))

table1 <- CreateTableOne(vars = vars, strata = "outcome", data = data)

print(table1, showAllLevels = TRUE)
```


```{r}
data_clean <- data %>%
  clean_names() %>%
  remove_empty("cols")

data_filtered <- data_clean %>%
  select_if(~ any(is.na(.)))

missing_data <- data_filtered %>%
  summarise_all(~sum(is.na(.))) %>%
  gather(key = "variable", value = "missing_count") %>%
  mutate(
    total_count = nrow(data_filtered),
    missing_percent = (missing_count / total_count) * 100
  )
new_names <- c(
  pco2 = "PCO2",
  ph = "pH",
  basophils = "Basophils",
  lactic_acid = "Lactic Acid",
  bmi = "BMI",
  creatine_kinase = "Creatine Kinase",
  los = "LOS",
  lymphocyte = "Lymphocyte",
  neutrophils = "Neutrophils",
  language = "Language",
  urine_output = "Urine Output",
  marital_status = "Marital Status",
  pt = "PT",
  inr = "INR",
  temperature = "Temperature",
  glucose = "Glucose",
  systolic_blood_pressure = "Systolic Blood Pressure",
  diastolic_blood_pressure = "Diastolic Blood Pressure",
  sp_o2 = "SpO2",
  respiratory_rate = "Respiratory Rate",
  heart_rate = "Heart Rate",
  blood_calcium = "Blood Calcium"
)

ggplot(missing_data, aes(x = reorder(variable, -missing_count), y = missing_count)) +
  geom_bar(stat = "identity", fill = "steelblue", width = 0.8) + 
  geom_text(aes(label = paste0(round(missing_percent, 1), "%")), 
            vjust = -0.5, 
            color = "black",
            size = 3, # Adjust size to minimize text
            nudge_y = 5) +
  labs(
    title = "Missing Data Overview",
    x = "Variables",
    y = "Number of Missing Values"
  ) +
  scale_x_discrete(labels = new_names) + # Apply the new names
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```




```{r}
library(glmnet)
library(data.table)
library(boot)

bootstrap_function <- function(data, indices) {
  # Resample the data
  boot_x <- x_train[indices, ]
  boot_y <- y_train[indices]
  
  # Fit the Elastic Net model
  fit <- glmnet(boot_x, boot_y, family = "binomial", alpha = best_alpha, lambda = best_lambda)
  
  # Extract the coefficients
  as.vector(coef(fit, s = best_lambda))
}

# Perform bootstrap resampling
set.seed(213)
boot_results <- boot(data = x_train, statistic = bootstrap_function, R = 1000)

# Extract the coefficients from the bootstrap results
coef_matrix <- t(boot_results$t)

# Get the variable names for the coefficients
coef_names <- rownames(coef(glmnet(x_train, y_train, family = "binomial", alpha = best_alpha, lambda = best_lambda)))

# Function to calculate confidence intervals for each coefficient
get_ci <- function(bootstrap_coefs) {
  apply(bootstrap_coefs, 1, function(coef_values) {
    quantile(coef_values, probs = c(0.025, 0.975))
  })
}

# Calculate confidence intervals for each coefficient
ci_matrix <- get_ci(coef_matrix)

# Create a data frame to store the confidence intervals
ci_df <- data.frame(
  Variable = coef_names,
  Lower_2.5 = ci_matrix[1, ],
  Upper_97.5 = ci_matrix[2, ]
)

ci_df <- ci_df[ci_df$Variable != "(Intercept)", ]
print(ci_df)
```

```{r}
library(ggplot2)
ggplot(ci_df, aes(x = Variable, ymin = Lower_2.5, ymax = Upper_97.5)) +
  geom_pointrange(aes(y = (Lower_2.5 + Upper_97.5) / 2), color = "blue") +
  coord_flip() +
  labs(title = "95% Confidence Intervals for Coefficients",
       y = "Coefficient Value",
       x = "Variable") +
  theme_minimal()

```
```{r}
significant_vars <- ci_df[ci_df$Lower_2.5 > 0 | ci_df$Upper_97.5 < 0, ]
insignificant_vars <- ci_df[ci_df$Lower_2.5 <= 0 & ci_df$Upper_97.5 >= 0, ]
cat("Significant Variables:\n")
print(significant_vars)
cat("Insignificant Variables:\n")
print(insignificant_vars)
significant_variable_names <- significant_vars$Variable
```


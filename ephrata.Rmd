---
title: "DMML_test"
author: ' '
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---


```{r}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(data.table)
library(tableone)
library(tidyr)
library(patchwork)
library(naniar)
library(janitor)
```

```{r}
data <- read.csv("merged_df_NEW.csv")
RF_impute_df <- fread("RF_imputation_NEW.csv")
data = subset(data, select = -c(deathtime, survival_time))
```



```{r}
vars <- c("age", "gendera")

data$gendera <- factor(data$gendera, levels = c(1, 2), labels = c("Male", "Female"))

table1 <- CreateTableOne(vars = vars, strata = "outcome", data = data)

print(table1, showAllLevels = TRUE)
```


```{r}
data_clean <- data %>%
  clean_names() %>%
  remove_empty("cols")

data_filtered <- data_clean %>%
  select_if(~ any(is.na(.)))

missing_data <- data_filtered %>%
  summarise_all(~sum(is.na(.))) %>%
  gather(key = "variable", value = "missing_count") %>%
  mutate(
    total_count = nrow(data_filtered),
    missing_percent = (missing_count / total_count) * 100
  )
new_names <- c(
  pco2 = "PCO2",
  ph = "pH",
  basophils = "Basophils",
  lactic_acid = "Lactic Acid",
  bmi = "BMI",
  creatine_kinase = "Creatine Kinase",
  los = "LOS",
  lymphocyte = "Lymphocyte",
  neutrophils = "Neutrophils",
  language = "Language",
  urine_output = "Urine Output",
  marital_status = "Marital Status",
  pt = "PT",
  inr = "INR",
  temperature = "Temperature",
  glucose = "Glucose",
  systolic_blood_pressure = "Systolic Blood Pressure",
  diastolic_blood_pressure = "Diastolic Blood Pressure",
  sp_o2 = "SpO2",
  respiratory_rate = "Respiratory Rate",
  heart_rate = "Heart Rate",
  blood_calcium = "Blood Calcium"
)

ggplot(missing_data, aes(x = reorder(variable, -missing_count), y = missing_count)) +
  geom_bar(stat = "identity", fill = "steelblue", width = 0.8) + 
  geom_text(aes(label = paste0(round(missing_percent, 1), "%")), 
            vjust = -0.5, 
            color = "black",
            size = 3, # Adjust size to minimize text
            nudge_y = 5) +
  labs(
    title = "Missing Data Overview",
    x = "Variables",
    y = "Number of Missing Values"
  ) +
  scale_x_discrete(labels = new_names) + # Apply the new names
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## EDA


```{r}
library(ggplot2)
library(patchwork)

# Define the function to create histograms with vertical mean line
create_histogram <- function(data, variable, units) {
  mean_value <- mean(data[[variable]], na.rm = TRUE)
  
  ggplot(data, aes_string(x = variable, fill = "factor(outcome)")) +
    geom_histogram(aes(y = ..density..), position = "identity", alpha = 0.5, bins = 20) +
    geom_vline(xintercept = mean_value, col = "red", lwd = 1, linetype = "dotted") +
    scale_fill_manual(values = c("blue", "green"), labels = c("Alive", "Dead")) +
    labs(title = paste("Distribution of", gsub("\\.", " ", variable), "by Outcome"),
         x = paste(gsub("\\.", " ", variable), "(", units, ")"),
         y = "Density",
         fill = "Outcome") +
    theme_minimal()
}

# List of variables to plot with their units
variables <- list(
  "Blood.calcium" = "Blood Calcium units",
  "Creatinine" = "Creatinine units",
  "PH" = "PH units",
  "Urea.nitrogen" = "Urea Nitrogen units"
)

# Create plots
plots <- lapply(names(variables), function(var) create_histogram(data, var, variables[[var]]))

# Arrange plots in a grid layout using patchwork
combined_plots <- wrap_plots(plots, nrow = 2, ncol = 2)

# Print combined plots
print(combined_plots)
```






```{r}
library(glmnet)
library(selectiveInference)
library(data.table)
```

```{r}
best_alpha <- 1
best_lambda <- 0.05
final_model <- glmnet(x_train, 
                      y_train, 
                      family = "binomial", 
                      alpha = best_alpha, 
                      lambda = best_lambda, thresh = 1e-10)
x_matrix <- model.matrix(y_train ~ x_train)
# class(x_matrix)
selected_vars <- which(coef(final_model, s = best_lambda) != 0)
selective_results <- fixedLassoInf(x_matrix[,selected_vars][,-1], 
                                   y_train, 
                                   family="binomial", 
                                   beta = coef(final_model, s = best_lambda, family="binomial")[selected_vars], 
                                   lambda = best_lambda * nrow(x_train), 
                                   sigma = sd(y_train - predict(final_model, x_train)))
print(selective_results)
# cor(x_matrix[,selected_vars][,-1])
```



